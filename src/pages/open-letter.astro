---
import Letter from "../layouts/Letter.astro";
import { getCollection } from 'astro:content';
import { getEntry } from 'astro:content';
import signatures from "../data/signatures.yaml";

const pages = await getCollection('pages');
console.log(`pages: ${pages.map(page => page.id)}`);
const entry = await getEntry('pages', 'letter');
console.log(`entry: ${entry}`);
if (!entry) throw new Error('Letter content not found');
const { Content } = await entry.render();
const { data } = entry;

// Convert ISO 3166-1 alpha-2 code to flag emoji (e.g. "US" â†’ ðŸ‡ºðŸ‡¸)
function regionFlag(code?: string): string {
  if (!code || code.length !== 2) return "\u{1F310}";
  return String.fromCodePoint(
    ...code.toUpperCase().split("").map(c => 0x1F1E6 + c.charCodeAt(0) - 65)
  );
}

// Logos stored as SVG for these domains; all others are PNG
const svgLogos = new Set(["appfair.org", "auroraoss.com", "guardianproject.info", "fastmail.com", "jmp.chat", "kde.org", "osmfoundation.org", "molly.im"]);
function logoPath(url: string): string {
  const ext = svgLogos.has(url) ? "svg" : "png";
  return `/img/logos/${url}.${ext}`;
}
---
<Letter {...data}>
  <article class="prose dark:prose-invert">
    <Content />
    <div class="signatories" id="signatories">
      <div class="sig-rule"></div>
      <h2>Signatories</h2>
      <ol>
        {signatures.map((sig: any) => (
          <li>
            <img class="sig-logo" src={logoPath(sig.url)} alt={`${sig.organization} logo`} loading="lazy" />
            <div class="sig-details">
              <span class="sig-name">{sig.organization}</span>
              <a target="_blank" href={`https://${sig.url}`}>{sig.url}<span class="sig-flag">{regionFlag(sig.region)}</span></a>
            </div>
          </li>
        ))}
      </ol>
      <div class="sig-rule"></div>
    </div>
  </article>
</Letter>

<style is:global>
  .signatories {
    margin-top: 4rem;
  }

  .sig-rule {
    border: none;
    height: 3px;
    background: linear-gradient(90deg, transparent, #333, transparent);
    margin: 0 auto;
    max-width: 60rem;
  }

  .signatories h2 {
    text-align: center;
    text-transform: uppercase;
    font-variant: small-caps;
    letter-spacing: 0.25em;
    font-weight: 900;
    font-size: 1.6rem;
    margin-top: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .sig-count {
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    font-size: 0.8rem;
    opacity: 0.5;
    margin-top: 0;
    margin-bottom: 2rem;
  }

  .signatories ol {
    list-style: none;
    padding: 0;
    margin: 0 auto 2rem;
    max-width: 60rem;
    columns: 1;
  }

  @media (min-width: 900px) {
    .signatories ol {
      columns: 2;
      column-gap: 2rem;
    }
  }

  .signatories li {
    display: flex;
    align-items: center;
    padding: 0.6rem 0;
    border-bottom: 1px solid rgba(128, 128, 128, 0.15);
    break-inside: avoid;
  }

  .signatories li:last-child {
    border-bottom: none;
    padding-bottom: 1.5rem;
  }

  .sig-logo {
    flex-shrink: 0;
    width: 1.5rem;
    height: 1.5rem;
    object-fit: contain;
    margin-inline-end: 0.75rem;
    border-radius: 4px;
  }

  .sig-details {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    min-width: 0;
  }

  .sig-name {
    font-weight: 800;
    font-size: 0.8rem;
    letter-spacing: 0.01em;
  }

  .sig-flag {
    margin-inline-start: 0.4em;
    font-size: 0.85em;
    vertical-align: middle;
  }

  .sig-details a {
    font-size: 0.8rem;
    opacity: 0.5;
    letter-spacing: 0.02em;
    text-decoration: none;
  }

  .sig-details a:hover {
    opacity: 0.8;
  }
</style>
